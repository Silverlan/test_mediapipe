name: Build Mediapipe - Linux

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install OpenCV
        shell: bash
        run: |
          sudo apt-get install -y \
              libopencv-core-dev \
              libopencv-highgui-dev \
              libopencv-calib3d-dev \
              libopencv-features2d-dev \
              libopencv-imgproc-dev \
              libopencv-video-dev
          sudo apt-get install -y libopencv-contrib-dev

      - name: Desktop example prerequisites
        shell: bash
        run: |
          # Requires a GPU with EGL driver support.
          # Can use mesa GPU libraries for desktop, (or Nvidia/AMD equivalent).
          sudo apt-get install mesa-common-dev libegl1-mesa-dev libgles2-mesa-dev

      - name: Clone Mediapipe
        shell: bash
        run: |
          git clone https://github.com/Silverlan/mediapipe.git
          cd mediapipe
          git checkout 10c5d914da87f41c99a79cc1eaebc9c242925b98

      - name: Clone mediapipe_pragma_wrapper
        uses: actions/checkout@v3
        with:
          repository: Silverlan/mediapipe_pragma_wrapper
          token: ${{ secrets.PRAGMA_MEDIAPIPE_WRAPPER_ACCESS_TOKEN }}
          path: mediapipe_pragma_wrapper
          ref: 461c91931ac64bcd67d32c1f3ca5ddd942e88ec1

      - name: Merge mediapipe_pragma_wrapper files
        shell: bash
        run: |
          cp -rfa mediapipe_pragma_wrapper/. mediapipe/

      - name: Install Python Dependencies
        shell: bash
        run: |
          # Install distutils
          sudo apt install python3-setuptools

          # Install numpy
          sudo apt install python3-numpy

      - name: Build
        shell: bash
        run: |
          cd mediapipe

          # Requires a GPU with EGL driver support.
          # Can use mesa GPU libraries for desktop, (or Nvidia/AMD equivalent).
          sudo apt-get install mesa-common-dev libegl1-mesa-dev libgles2-mesa-dev
          export GLOG_logtostderr=1

          # if you are running on Linux desktop with CPU only
          bazel run --define MEDIAPIPE_DISABLE_GPU=1 \
              mediapipe/examples/desktop/mediapipe_pragma_wrapper:mediapipe_pragma_wrapper

          # If you are running on Linux desktop with GPU support enabled (via mesa drivers)
          bazel run --copt -DMESA_EGL_NO_X11_HEADERS --copt -DEGL_NO_X11 \
              mediapipe/examples/desktop/mediapipe_pragma_wrapper:mediapipe_pragma_wrapper

      - name: Handle Error
        uses: Silverlan/common_actions/action_handle_error@main
        if: failure()
