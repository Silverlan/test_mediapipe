name: Build Mediapipe - Linux

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install OpenCV
        shell: bash
        run: |
          sudo apt-get install -y \
              libopencv-core-dev \
              libopencv-highgui-dev \
              libopencv-calib3d-dev \
              libopencv-features2d-dev \
              libopencv-imgproc-dev \
              libopencv-video-dev
          sudo apt-get install -y libopencv-contrib-dev

      - name: Desktop example prerequisites
        shell: bash
        run: |
          # Requires a GPU with EGL driver support.
          # Can use mesa GPU libraries for desktop, (or Nvidia/AMD equivalent).
          sudo apt-get install mesa-common-dev libegl1-mesa-dev libgles2-mesa-dev

      - name: Clone Mediapipe
        shell: bash
        run: |
          git clone https://github.com/Silverlan/mediapipe.git
          cd mediapipe
          git checkout 9ea1acfd70ae0679c05c6c44871a4be5abc16ad7

      - name: Clone mediapipe_pragma_wrapper
        uses: actions/checkout@v3
        with:
          repository: Silverlan/mediapipe_pragma_wrapper
          token: ${{ secrets.PRAGMA_MEDIAPIPE_WRAPPER_ACCESS_TOKEN }}
          path: mediapipe_pragma_wrapper
          ref: 706bb851bab9e0b54ce2113a9a236f5fecab30c4

      - name: Merge mediapipe_pragma_wrapper files
        shell: bash
        run: |
          cp -rfa mediapipe_pragma_wrapper/. mediapipe/

      - name: Install Python Dependencies
        shell: bash
        run: |
          # Install distutils
          sudo apt install python3-setuptools

          # Install numpy
          sudo apt install python3-numpy

      - name: Build
        shell: bash
        run: |
          bazel_output_root="$(pwd)/_bazel"
          cd mediapipe

          # Requires a GPU with EGL driver support.
          # Can use mesa GPU libraries for desktop, (or Nvidia/AMD equivalent).
          sudo apt-get install mesa-common-dev libegl1-mesa-dev libgles2-mesa-dev
          export GLOG_logtostderr=1

          # if you are running on Linux desktop with CPU only
          bazel --output_user_root="$bazel_output_root" build --define MEDIAPIPE_DISABLE_GPU=1 \
              mediapipe/examples/desktop/mediapipe_pragma_wrapper:mediapipe_pragma_wrapper

      - name: Generate Release Files
        shell: bash
        run: |
          # Get the Bazel binary output directory.
          cd mediapipe
          output_dir=$(bazel info bazel-bin)
          cd $output_dir
          ls -R

      - name: Handle Error
        uses: Silverlan/common_actions/action_handle_error@main
        if: failure()
